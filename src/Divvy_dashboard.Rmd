---
title: "Divvy Dashboard"
author: "Zack Larsen"
date: "May 15, 2019"
output: 
  flexdashboard::flex_dashboard:
    theme: "journal"
    social: [ "twitter", "facebook", "menu" ]
    navbar:
      - { title: "About Me", href: "https://zacklarsen.github.io/" }
      - { icon: "fa-github", href: "https://github.com/ZackLarsen", align: right}
      - { icon: "fa-linkedin", href: "https://www.linkedin.com/in/larsenzachary/", align: right}
---

```{r setup, include=FALSE}
library(pacman)
library(tidyverse)
p_load(flexdashboard, leaflet, dplyr, ggvis, here, conflicted, data.table, jsonlite, kableExtra, glue, geosphere, DT, networkD3, htmltools, geojsonio, data.table, magrittr)
conflict_prefer("filter", "dplyr")

here::here()

stations <- fromJSON("https://feeds.divvybikes.com/stations/stations.json")

divvy_trips <- fread(here("data",'Divvy_trips_sample.csv'))

chi_zips <- geojsonio::geojson_read(here("data",'Chicago_Zipcodes.geojson'),
                                      what = "sp")

ward_boundaries <- geojsonio::geojson_read(here("data","Boundaries_Wards.geojson"), what = "sp")

# https://cfss.uchicago.edu/notes/leaflet/

```


Landing Page - Stations
=========================================

Column 
-------------------------------------

### Divvy Stations, plotted using leaflet. This map can be zoomed in on interactively and the station names will be displayed upon clicking the icon.

```{r, cache=TRUE}

# my_map <- leaflet(stations$stationBeanList) %>%
#   addTiles() %>%
#   addMarkers(lat = stations$stationBeanList$latitude, 
#              lng = stations$stationBeanList$longitude,
#              popup = stations$stationBeanList$stationName,
#              label = stations$stationBeanList$id)
# my_map




icons <- awesomeIcons(
  icon = 'bicycle',
  iconColor = 'white',
  library = 'fa',
  iconRotate = 0,
  markerColor = "blue" #getColor(stations$stationBeanList$availableBikes)
)

leaflet(stations$stationBeanList) %>%
  addTiles() %>%
  addAwesomeMarkers(
    ~longitude, 
    ~latitude, 
    icon=icons, 
    label=~as.character(stationName)
  )

```

***

https://rstudio.github.io/leaflet/

- Interactive panning/zooming

- Notice the icons, when clicked, display the station name


Column {.tabset}
-------------------------------------
   
### Empty Stations

```{r, cache=TRUE}

stations$stationBeanList %>% 
  select(id, stationName, availableDocks, availableBikes) %>% 
  arrange(-availableDocks) %>% 
  head(n=20) %>% 
  kable() %>% 
  kable_styling()

```   


### Full Stations
    
```{r, cache=TRUE}

stations$stationBeanList %>% 
  select(id, stationName, availableDocks, availableBikes) %>% 
  arrange(availableDocks) %>% 
  head(n=20) %>% 
  kable() %>% 
  kable_styling()

```


### Largest Stations
    
```{r, cache=TRUE}

stations$stationBeanList %>% 
  select(id, stationName, totalDocks) %>% 
  arrange(-totalDocks) %>% 
  head(n=20) %>% 
  kable() %>% 
  kable_styling()

```


### Smallest Stations
    
```{r, cache=TRUE}

stations$stationBeanList %>% 
  select(id, stationName, totalDocks) %>% 
  arrange(totalDocks) %>% 
  head(n=20) %>% 
  kable() %>% 
  kable_styling()

```


### Damen Stations

```{r, cache=TRUE}

stations$stationBeanList %>%
  filter(
    #id == 2,
    is_renting == TRUE,
    #availableDocks < 5,
    stAddress1 %like% 'Damen'
    ) %>% 
  kable() %>% 
  kable_styling()

```

Station Features {.storyboard}
=========================================


### Zip Codes

```{r, cache=TRUE}

# https://data.cityofchicago.org/browse/select_dataset?tags=shapefiles&utf8=%E2%9C%93
chi_zips <- geojsonio::geojson_read('/Users/zacklarsen/Zack_Master/Projects/Dataviz/R/flex/data/Chicago_Zipcodes.geojson', what = "sp")

factblues <- colorFactor(palette = "Blues", chi_zips$zip)

leaflet(chi_zips) %>%
  addTiles() %>%
  addPolygons(fillColor = ~factblues(zip),
              weight = 2,
              opacity = 1,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7,
              highlight = highlightOptions(
                weight = 5,
                color = "#666",
                dashArray = "",
                fillOpacity = 0.7,
                bringToFront = TRUE),
              label = ~zip,
              labelOptions = labelOptions(
                style = list("font-weight" = "normal", padding = "3px 8px"),
                textsize = "15px",
                direction = "auto")) %>% 
  addLegend(pal = factblues, values = ~zip, opacity = 0.7, title = NULL,
            position = "topright")

```


### Popups

```{r, cache=TRUE, eval=TRUE}

content_df <- stations$stationBeanList %>%
    sample_n(100) %>% 
  mutate(
    content = paste(
      sep = "<br/>",
      glue("<b><a>{stationName}</a></b>"),
      #stAddress1,
      paste(city,'IL',postalCode, sep=', '),
      paste(latitude, longitude, sep=', ')
    )
  )

leaflet(content_df) %>%
  setView(-87.653449, 41.894556, 11) %>% # This line sets the default zoom
  addTiles() %>%
  addMarkers(
    content_df$longitude,
    content_df$latitude,
    popup = ~content_df$content
  )

```


### Labels

```{r, cache=TRUE, eval=TRUE}

content_df2 <- stations$stationBeanList %>%
  sample_n(100) 

labs <- lapply(seq(nrow(content_df2)), function(i) {
  paste0('<p><b><a>', content_df2[i, "stationName"], '</a></b><p></p>', 
          content_df2[i, "city"], ', IL, ', 
          content_df2[i, "postalCode"],'</p><p>', 
          content_df2[i, "latitude"], ', ', content_df2[i, "longitude"], '</p>'
         )
  }
)

leaflet(content_df2) %>%
  setView(-87.653449, 41.894556, 11) %>% # This line sets the default zoom
  addTiles() %>%
  addMarkers(
    content_df2$longitude,
    content_df2$latitude,
    label = lapply(labs, HTML)
  )

```


### Clusters

```{r, cache=TRUE}

leaflet(stations$stationBeanList) %>%
  addTiles() %>%
  addMarkers(
    lat = stations$stationBeanList$latitude, 
    lng = stations$stationBeanList$longitude,
    popup = stations$stationBeanList$stationName,
    label = stations$stationBeanList$id,
    clusterOptions = markerClusterOptions()
  )

```


### Circles

```{r, cache=TRUE}

leaflet(stations$stationBeanList) %>%
  addTiles() %>%
  addCircleMarkers()

```


### Custom Circles

```{r, cache=TRUE}

# Create a palette that maps factor levels to colors
pal <- colorFactor(c("red", "blue"), domain = c(TRUE, FALSE))

leaflet(stations$stationBeanList) %>%
  addTiles() %>%
  addCircleMarkers(
    radius = ~ifelse(is_renting == TRUE, 10, 5),
    color = ~pal(is_renting),
    stroke = FALSE, fillOpacity = 0.5
  ) %>% 
  addLegend("topright", pal = pal, values = ~is_renting,
    title = "Renting Currently Or Not",
    #labFormat = labelFormat(prefix = "$"),
    opacity = 1
  )

```


### Custom Icons

```{r, cache=TRUE}

# https://rstudio.github.io/leaflet/markers.html

greenLeafIcon <- makeIcon(
  #iconUrl = "http://leafletjs.com/examples/custom-icons/leaf-green.png",
  iconUrl = "/Users/zacklarsen/Zack_Master/Projects/Dataviz/R/flex/Divvy-icon.png",
  iconWidth = 35, iconHeight = 35,
  iconAnchorX = 0, iconAnchorY = 10
  
  #,
  #shadowUrl = "http://leafletjs.com/examples/custom-icons/leaf-shadow.png",
  #shadowWidth = 50, shadowHeight = 64,
  #shadowAnchorX = 4, shadowAnchorY = 62
)

leaflet(stations$stationBeanList) %>%
  addTiles() %>%
  addMarkers(~longitude, ~latitude, icon = greenLeafIcon)

```


### Custom Tiles Toner

```{r, cache=TRUE}

# https://leaflet-extras.github.io/leaflet-providers/preview/index.html

leaflet(stations$stationBeanList) %>%
  # Base groups
  addTiles(group = "Default") %>%
  addProviderTiles(providers$Stamen.Toner, group = "Toner") %>%
  addProviderTiles(providers$Stamen.Watercolor, group = "Watercolor") %>% 
  addProviderTiles(providers$NASAGIBS.ViirsEarthAtNight2012, group = "NASA") %>%
  # Overlay groups
  addCircles(~longitude, ~latitude, group = "Stations") %>%
  # Layers control
  addLayersControl(
    baseGroups = c("Default", "Toner", "Watercolor", "NASA"),
    overlayGroups = c("Stations"),
    options = layersControlOptions(collapsed = FALSE)
  )

# # Toner
# leaflet(stations$stationBeanList) %>%
#   addProviderTiles(providers$Stamen.Toner) %>%
#   addMarkers(~longitude, ~latitude, icon = greenLeafIcon)
# 
# # Watercolor
# leaflet(stations$stationBeanList) %>%
#   addProviderTiles(providers$Stamen.Watercolor) %>%
#   addMarkers(~longitude, ~latitude, icon = greenLeafIcon)
# 
# # NASA
# leaflet(stations$stationBeanList) %>%
#   addProviderTiles(providers$NASAGIBS.ViirsEarthAtNight2012) %>%
#   addMarkers(~longitude, ~latitude, icon = greenLeafIcon)

```


Landing Page - Trips
=========================================

Column {.tabset}
-------------------------------------

### Divvy Trips Raw

```{r, cache=TRUE}

divvy_trips %>% 
  tibble()

# divvy_trips %>% 
#   head(50) %>% 
#   datatable(
#   caption = 'Table 1: Divvy Trips.',
#   options = list(
#     buttons = c('csv'), 
#     paging = TRUE,
#     scrollX = FALSE,
#     initComplete = JS(
#       "function(settings, json) {",
#       "$(this.api().table().header()).css({'background-color': '#000', 'color': '#fff'});",
#       "}")
#   )
# )

```

***

- Trip data provided by Divvy represents trips taken by Divvy users for the past several years


Column {.tabset}
-------------------------------------

### Most Popular Departure Stations

```{r, cache=TRUE}

divvy_trips %>% 
  select(`FROM STATION NAME`) %>% 
  group_by(`FROM STATION NAME`) %>% 
  tally() %>% 
  arrange(-n) %>% 
  kable() %>% 
  kable_styling()

```   


### Most Popular Destination Stations
    
```{r, cache=TRUE}

divvy_trips %>% 
  select(`TO STATION NAME`) %>% 
  group_by(`TO STATION NAME`) %>% 
  tally() %>% 
  arrange(-n) %>% 
  kable() %>% 
  kable_styling()

```


### Most Popular Route
    
```{r, cache=TRUE}

divvy_trips %>% 
  group_by(paste(`FROM STATION NAME`, 'to', `TO STATION NAME`)) %>% 
  tally() %>% 
  arrange(-n) %>% 
  head(20) %>% 
  kable() %>% 
  kable_styling()

```


### Greatest Distance Traveled
    
```{r, cache=TRUE}

# distm(c(-87.68585, 41.90778), c(-87.67769, 41.90940), fun = distHaversine)
# 
# distm(c(-87.68585, 41.90778), c(-87.67769, 41.90940), fun = distGeo)
# 
# distCosine(c(-87.68585, 41.90778), c(-87.67769, 41.90940), r=6378137)
# 
# distGeo(c(-87.68585, 41.90778), c(-87.67769, 41.90940), a=6378137, f=1/298.257223563)

# my_geo <- function(lat1, lon1, lat2, lon2){
#   distGeo(c(lat1, lon1), c(lat2, lon2), a=6378137, f=1/298.257223563)
# }

# https://markhneedham.com/blog/2014/12/04/r-applying-a-function-to-every-row-of-a-data-frame/

divvy_trips %>% 
  mutate(
    DISTANCE = by(divvy_trips, 1:nrow(divvy_trips), function(row) { 
  distGeo(c(row$`FROM LATITUDE`, row$`FROM LONGITUDE`), c(row$`TO LATITUDE`, row$`TO LONGITUDE`), a=6378137, f=1/298.257223563) 
  }
    )
  ) %>% 
  arrange(-DISTANCE) %>% 
  mutate(DISTANCE_MILES = DISTANCE / 1609.344) %>% 
  select(`TRIP ID`, `FROM STATION NAME`, `TO STATION NAME`, DISTANCE_MILES) %>%
  head(20) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  rename(`DISTANCE (MILES)` = DISTANCE_MILES) %>% 
  kable() %>% 
  kable_styling()

```


### Greatest Average Speed
    
```{r, cache=TRUE}

divvy_trips %>% 
  mutate(
    DISTANCE = by(divvy_trips, 1:nrow(divvy_trips), function(row) { 
  distGeo(c(row$`FROM LATITUDE`, row$`FROM LONGITUDE`), c(row$`TO LATITUDE`, row$`TO LONGITUDE`), a=6378137, f=1/298.257223563) 
  }
    )
  ) %>% 
  mutate(SPEED = (DISTANCE / 1609.344) / (`TRIP DURATION` / 3600)) %>% 
  arrange(-SPEED) %>% 
  select(`TRIP ID`, `FROM STATION NAME`, `TO STATION NAME`, SPEED) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  rename(`SPEED (MPH)` = SPEED) %>% 
  head(20) %>% 
  kable() %>% 
  kable_styling()

```


Trip Features {.storyboard}
=========================================


### Ward Trip Density

```{r ward_trip_counts, cache=TRUE}

ward_totals <- divvy_trips %>% 
  select(Wards) %>% 
  group_by(Wards) %>% 
  tally() %>% 
  rename(count = n)

# Define color palette
bins <- c(0, 10, 20, 30, 40, 50, Inf)
pal <- colorBin("YlOrRd", domain = ward_totals$count, bins = bins)

df50 <- as.data.frame(1:50)
colnames(df50) <- "Wards"

newdf <- left_join(df50, ward_totals, "Wards") 

newdf$count %<>% 
  replace_na(0)

ward_totals <- setNames(newdf$count, as.character(newdf$Wards))


# Add information to geojson data by using the named vector above
ward_boundaries$trip_count <- ward_totals


# Create the HTML content to serve as the popup label
labels <- sprintf(
  "<strong>Ward #%s</strong><br/> %g Trips taken from this ward",
  ward_boundaries$ward, ward_boundaries$trip_count
) %>% lapply(htmltools::HTML)


ward_boundaries %>%
  leaflet() %>%
  addTiles() %>%
  addPolygons(fillColor = ~pal(trip_count),
              color = "#444444",
              weight = 1,
              smoothFactor = 0.5,
              opacity = 1.0,
              fillOpacity = 0.5,
              highlightOptions = highlightOptions(color = "white",
                                                  weight = 2,
                                                  bringToFront = TRUE),
              label = ~labels,
              labelOptions = labelOptions(
                style = list("font-weight" = "normal", padding = "3px 8px"),
                textsize = "15px",
                direction = "auto")) %>%
  addLegend(pal = pal,
            values = ~trip_count,
            opacity = 0.7,
            title = NULL,
            position = "bottomright")

```



### Lines

```{r, cache=TRUE}



```


### Zip Code Mapped To Trips

```{r, cache=TRUE}

#chi_zips

as.data.frame(chi_zips)

# zip_trip_counts <- divvy_trips %>% 
#   select(`FROM STATION ID`) %>% 
#   group_by(`FROM STATION ID`) %>% 
#   summarise(trip_count = n())
# 
# zip_trip_counts




# stations


#merge(chi_zips, zip_trip_counts, by.x = "zip", by.y = "Zip Codes")

# Create a continuous palette function
# blues <- colorNumeric(
#   palette = "Blues",
#   domain = chi_zips$trip_count)
# 
# leaflet(chi_zips) %>%
#   addTiles() %>%
#   addPolygons(fillColor = ~blues(zip),
#               weight = 2,
#               opacity = 1,
#               color = "white",
#               dashArray = "3",
#               fillOpacity = 0.7,
#               highlight = highlightOptions(
#                 weight = 5,
#                 color = "#666",
#                 dashArray = "",
#                 fillOpacity = 0.7,
#                 bringToFront = TRUE),
#               label = ~zip,
#               labelOptions = labelOptions(
#                 style = list("font-weight" = "normal", padding = "3px 8px"),
#                 textsize = "15px",
#                 direction = "auto")) %>% 
#   addLegend(pal = blues, values = ~zip, opacity = 0.7, title = NULL,
#             position = "topright")



# ward_totals <- crimes %>% 
#   select(Ward, `Primary Type`) %>% 
#   group_by(Ward) %>% 
#   summarise(n()) %<>% 
#   mutate(count = `n()` * 50)
# 
# ward_totals <- setNames(ward_totals$count, as.character(ward_totals$Ward))
# 
# ward_boundaries$crime_total <- ward_totals
# 
# qpal <- colorQuantile("Reds", ward_boundaries$crime_total, n = 10)
# 
# leaflet(ward_boundaries) %>%
#   addTiles() %>%
#   addPolygons(fillColor = ~qpal(crime_total),
#               weight = 2,
#               opacity = 1,
#               color = "white",
#               dashArray = "3",
#               fillOpacity = 0.9,
#               highlight = highlightOptions(
#                 weight = 5,
#                 color = "#666",
#                 dashArray = "",
#                 fillOpacity = 0.7,
#                 bringToFront = TRUE),
#               label = ~ward,
#               labelOptions = labelOptions(
#                 style = list("font-weight" = "normal", padding = "3px 8px"),
#                 textsize = "15px",
#                 direction = "auto")) %>% 
#   addLegend(pal = qpal, 
#             values = ~crime_total,
#             opacity = 0.7, 
#             title = "Crime Count Quantile",
#             position = "topright")

```


### Simple Network Viz

```{r, cache=TRUE, eval=FALSE}

simpleNetwork(divvy_trips %>% 
                select(`FROM STATION NAME`, `TO STATION NAME`) %>% 
                head(1000),
              opacity = 0.4
              )

```


### Force Network Viz

```{r, cache=TRUE, eval=FALSE}

# First, we need the frequency of trips from one station to the next
# source, target, value
DivvyLinks <- divvy_trips %>% 
  head(1000) %>% 
  group_by(paste(`FROM STATION NAME`, 'to', `TO STATION NAME`)) %>% 
  add_tally() %>% 
  ungroup() %>% 
  arrange(-n) %>% 
  select(`FROM STATION NAME`, `TO STATION NAME`, n) %>% 
  rename(source = `FROM STATION NAME`, target = `TO STATION NAME`, value = n) %>% 
  distinct()

# DivvyLinks %>% 
#   kable() %>% 
#   kable_styling()

# Secondly, we need the number of trips taken from a given departure station
# name, group, size
DivvyNodes <- divvy_trips %>% 
  head(1000) %>% 
  group_by(`FROM STATION NAME`) %>% 
  add_tally() %>% 
  ungroup() %>% 
  arrange(-n) %>% 
  rename(COUNT = n) %>% 
  select(`FROM STATION NAME`, Wards, COUNT) %>% 
  rename(name = `FROM STATION NAME`, group = Wards, size = COUNT) %>% 
  distinct() 

# DivvyNodes %>% 
#   kable() %>% 
#   kable_styling()

# forceNetwork(Links = DivvyLinks, Nodes = DivvyNodes, Source = "source", Target = "target", Value = "value", NodeID = "name", Group = "group", opacity = 0.4)

```


### Force Network Viz Example

```{r, cache=TRUE, eval=FALSE}
data(MisLinks, MisNodes)

#MisLinks # source, target, value

#MisNodes # name, group, size


# http://curleylab.psych.columbia.edu/netviz/netviz2.html#/

# with a simple click action - make the circles bigger when clicked
MyClickScript <- 'd3.select(this)
.select("circle")
.transition()
.duration(750)
.attr("r", 40)'


browsable(
  tagList(
    forceNetwork(Links = MisLinks, Nodes = MisNodes, Source = "source",
             Target = "target", Value = "value", NodeID = "name",
             #Nodesize = 'betweenness',
             Group = "group", opacity = 0.4, 
             charge = -50, # node repulsion
             linkDistance = 20,
             zoom = T,
             clickAction = MyClickScript),
    tags$script(
      'document.body.style.backgroundColor = "#000000"'      
    )
  )
)
```

